# Maintainer: Saim <saim20 at github dot com>
pkgname=willow-git
pkgver=r100.abc1234
pkgrel=1
pkgdesc="Simple offline configurable voice assistant for gnome (git version)"
arch=('x86_64')
url="https://github.com/Saim20/willow"
license=('MIT')
depends=(
    'gnome-shell>=45'
    'sdbus-cpp'
    'jsoncpp'
    'libpulse'
    'ydotool'
)
makedepends=(
    'cmake'
    'git'
    'gcc'
)
optdepends=(
    'cuda: for NVIDIA GPU acceleration'
    'vulkan-icd-loader: for Vulkan GPU acceleration (AMD/Intel/NVIDIA)'
    'vulkan-headers: for Vulkan GPU acceleration build support'
)
options=('!debug')
provides=('willow')
conflicts=('willow')
install=willow.install
source=("git+https://github.com/Saim20/willow.git")
sha256sums=('SKIP')

# Build options
: ${ENABLE_CUDA:=0}
: ${ENABLE_VULKAN:=0}
_enable_cuda=${ENABLE_CUDA}
_enable_vulkan=${ENABLE_VULKAN}

pkgver() {
    cd "$srcdir/willow"
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
    cd "$srcdir/willow"
    
    # Clone whisper.cpp if not present
    if [ ! -d "whisper.cpp" ]; then
        printf "Cloning whisper.cpp...\n"
        git clone --depth 1 https://github.com/ggerganov/whisper.cpp.git
    fi
}

build() {
    cd "$srcdir/willow"
    
    # Build the C++ service with whisper.cpp
    cd service
    
    # Create build directory
    rm -rf build
    mkdir -p build
    cd build
    
    # Configure with CMake
    local cmake_args=(
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_INSTALL_PREFIX=/usr
        -DWHISPER_CPP_DIR="$srcdir/willow/whisper.cpp"
    )
    
    # Add GPU acceleration options
    if [ "$_enable_cuda" = "1" ]; then
        cmake_args+=(-DGGML_CUDA=ON)
    fi
    
    if [ "$_enable_vulkan" = "1" ]; then
        cmake_args+=(-DGGML_VULKAN=ON)
    fi
    
    cmake "${cmake_args[@]}" ..
    make -j$(nproc)
}

package() {
    cd "$srcdir/willow"
    
    # Install service binary and D-Bus files
    cd service/build
    make DESTDIR="$pkgdir" install
    
    cd "$srcdir/willow"
    
    # Install systemd service
    install -Dm644 systemd/willow.service \
        "$pkgdir/usr/lib/systemd/user/willow.service"
    
    # Install GNOME extension
    local ext_dir="$pkgdir/usr/share/gnome-shell/extensions/willow@saim"
    mkdir -p "$ext_dir"
    cp -r gnome-extension/willow@saim/* "$ext_dir/"
    
    # Compile GSettings schema
    glib-compile-schemas "$ext_dir/schemas/" || true
    
    # Install default configuration
    install -Dm644 config.json \
        "$pkgdir/usr/share/willow/config.json"
    
    # Install LICENSE
    install -Dm644 LICENSE \
        "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
    
    # Install documentation
    install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
    
    # Install download helper script
    install -Dm755 download-model.sh "$pkgdir/usr/bin/willow-download-model"
}
